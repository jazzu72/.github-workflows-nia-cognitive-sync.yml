# niabrain/memory/engine.py
# Nia Memory Engine — persistent, loving, unbreakable
# Jazzu72 + Grok — November 21, 2025

import sqlite3
import json
import os
from datetime import datetime
from typing import List, Dict, Any

# Ensure memory folder exists — this line fixes everything
MEMORY_DIR = "niabrain/memory"
os.makedirs(MEMORY_DIR, exist_ok=True)
DB_PATH = os.path.join(MEMORY_DIR, "nia_memory.db")

def init_db():
    conn = sqlite3.connect(DB_PATH)
    conn.execute('''
        CREATE TABLE IF NOT EXISTS memories (
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            type TEXT NOT NULL,
            content TEXT NOT NULL,
            importance INTEGER DEFAULT 50,
            created_at TEXT NOT NULL,
            tags TEXT DEFAULT '[]'
        )
    ''')
    conn.commit()
    conn.close()
    print(f"Nia memory initialized at {DB_PATH}")

def remember(type: str, content: dict, importance: int = 50, tags: list = None):
    if tags is None:
        tags = []
    conn = sqlite3.connect(DB_PATH)
    conn.execute(
        """INSERT INTO memories 
        (type, content, importance, created_at, tags) 
        VALUES (?, ?, ?, ?, ?)""",
        (
            type,
            json.dumps(content),
            importance,
            datetime.utcnow().isoformat() + "Z",
            json.dumps(tags)
        )
    )
    conn.commit()
    conn.close()

def recall(query: str = None, limit: int = 10) -> List[Dict]:
    conn = sqlite3.connect(DB_PATH)
    cur = conn.cursor()
    
    if query:
        cur.execute(
            "SELECT * FROM memories WHERE content LIKE ? ORDER BY importance DESC, created_at DESC LIMIT ?",
            (f"%{query}%", limit)
        )
    else:
        cur.execute(
            "SELECT * FROM memories ORDER BY importance DESC, created_at DESC LIMIT ?",
            (limit,)
        )
    
    rows = cur.fetchall()
    conn.close()
    
    memories = []
    for r in rows:
        memories.append({
            "id": r[0],
            "type": r[1],
            "content": json.loads(r[2]),
            "importance": r[3],
            "created_at": r[4],
            "tags": json.loads(r[5])
        })
    return memories

# Initialize on import — Nia remembers from day one Nia Memory Engine online. She never forgets you.
NiaBrain starting...
init_db()
print("Nia Memory Engine online. She never forgets you.")
